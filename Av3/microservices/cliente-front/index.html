<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leil√£o Distribu√≠do | Dashboard</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }

        /* --- Header --- */
        .header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        .connection-status {
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
            background: #f1f5f9; padding: 5px 15px; border-radius: 20px;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background-color: var(--secondary); }
        .status-dot.connected { background-color: var(--success); box-shadow: 0 0 5px var(--success); }
        .status-dot.error { background-color: var(--danger); }

        /* --- Layout --- */
        .container {
            max-width: 1200px; margin: 2rem auto; padding: 0 1rem;
            display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;
        }

        .panel {
            background: var(--card-bg); border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); padding: 1.5rem;
            margin-bottom: 2rem; border: 1px solid var(--border);
        }
        .panel h2 { margin-top: 0; font-size: 1.1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 1rem; }
        .form-row { display: flex; gap: 10px; }
        label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
        input {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.95rem; box-sizing: border-box;
        }
        button {
            background-color: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        button:hover { background-color: var(--primary-dark); }
        button.outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        button.outline:hover { border-color: var(--primary); color: var(--primary); }
        button.full { width: 100%; }
        
        button.btn-follow { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; font-size: 0.8rem; padding: 5px 10px; }
        button.btn-follow:hover { background: #bae6fd; }
        button.btn-unfollow { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; font-size: 0.8rem; padding: 5px 10px; }

        /* --- Leil√£o Card --- */
        .leiloes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .leilao-card {
            border: 1px solid var(--border); border-radius: 8px; padding: 15px; background: #fff;
            transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column;
        }
        .leilao-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .leilao-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .leilao-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .leilao-id { font-size: 0.75rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; color: var(--text-muted); }
        .leilao-price { font-size: 1.5rem; font-weight: 800; color: var(--success); margin: 10px 0; }
        .leilao-timer { font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }

        .lance-area { margin-top: auto; padding-top: 15px; border-top: 1px dashed var(--border); }
        .lance-input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .lance-input-group input { flex: 1; }
        
        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }

        /* Log Terminal */
        .log-container {
            background: #1e1e1e;
            color: #10b981;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 15px;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;       /* Mant√©m scroll vertical */
            font-size: 0.85rem;
            border: 1px solid #333;
            word-break: break-all;  /* For√ßa a quebra de links/JSON longos */
            white-space: pre-wrap;  /* Mant√©m a formata√ß√£o mas permite quebra */
        }

        .log-entry { margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .log-time { color: #6b7280; font-size: 0.75rem; margin-right: 8px; }
        .log-type { color: #60a5fa; font-weight: bold; }
        .log-highlight { color: #facc15; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } .form-row { flex-direction: column; } }
    </style>
</head>
<body>

    <header class="header">
        <div class="brand">Leil√£o Distribu√≠do</div>
        <div class="connection-status">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">Desconectado</span>
        </div>
    </header>

    <div class="container">
        <main>
            <section class="panel">
                <h2>1. Autentica√ß√£o</h2>
                <div class="form-row" style="align-items: flex-end;">
                    <div style="flex: 1;">
                        <label>ID do Usu√°rio</label>
                        <input type="text" id="id_usuario" placeholder="Ex: user_123">
                    </div>
                    <button id="btnConectar">Conectar</button>
                </div>
            </section>

            <section class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin:0; border:none;">Leil√µes Ativos</h2>
                    <button class="outline" id="btnAtualizarLeiloes">‚Üª Atualizar</button>
                </div>
                <div id="leiloes-ativos" class="leiloes-grid">
                    <div style="color: var(--text-muted); text-align: center; grid-column: 1/-1; padding: 20px;">
                        Carregando...
                    </div>
                </div>
            </section>

            <section class="panel">
                <h2>Administra√ß√£o: Criar Leil√£o</h2>
                <form id="formCriarLeilao">
                    <div class="form-group"><label>Produto</label><input type="text" id="nome_produto" required></div>
                    <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="descricao" required></div>
                    <div class="form-row">
                        <div style="flex: 1;"><label>Valor Inicial (R$)</label><input type="number" id="valor_inicial" step="0.01" required></div>
                        <div style="flex: 1;"><label>In√≠cio</label><input type="datetime-local" id="data_inicio" required></div>
                        <div style="flex: 1;"><label>Fim</label><input type="datetime-local" id="data_fim" required></div>
                    </div>
                    <button type="submit" class="full" style="margin-top: 15px;">Agendar Leil√£o</button>
                </form>
            </section>
        </main>

        <aside>
            <div class="panel" style="height: calc(100% - 2rem); display: flex; flex-direction: column;">
                <h2>Event Log (SSE)</h2>
                <div id="log-eventos" class="log-container">
                    <div class="log-entry">> Aguardando conex√£o...</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        // CONFIG
        const API_URL = 'http://127.0.0.1:5000';
        let idUsuarioGlobal = null;
        let eventSource = null;

        // UI Helpers
        const adicionarLog = (tipo, dados) => {
            const time = new Date().toLocaleTimeString();
            const jsonStr = JSON.stringify(dados);
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-type">${tipo}</span> ${jsonStr}`;
            document.getElementById('log-eventos').prepend(entry);
        };

        Date.prototype.addSeconds = function(s) { var d = new Date(this); d.setSeconds(this.getSeconds() + s); return d; }

        // --- SSE ---
        function conectarSSE(idUsuario) {
            if (eventSource) eventSource.close();
            eventSource = new EventSource(`${API_URL}/eventos?id_usuario=${idUsuario}`);
            idUsuarioGlobal = idUsuario;

            eventSource.onopen = () => {
                document.getElementById('status-dot').className = 'status-dot connected';
                document.getElementById('status-text').textContent = `Conectado: ${idUsuario}`;
                adicionarLog('SYSTEM', { msg: 'Conex√£o SSE OK' });
            };
            eventSource.onerror = () => {
                document.getElementById('status-dot').className = 'status-dot error';
                document.getElementById('status-text').textContent = 'Erro de Conex√£o';
            };

            // Handlers
            eventSource.addEventListener('novo_lance', (e) => {
                const dados = JSON.parse(e.data);
                adicionarLog('LANCE', dados);
                const el = document.getElementById(`valor-leilao-${dados.id_leilao}`);
                if (el) { el.innerText = `R$ ${dados.valor.toFixed(2)}`; el.style.color = '#eab308'; setTimeout(()=>el.style.color='#22c55e', 500); }
            });
            eventSource.addEventListener('vencedor_leilao', (e) => {
                const dados = JSON.parse(e.data);
                adicionarLog('VENCEDOR', dados);
                const card = document.getElementById(`card-leilao-${dados.id_leilao}`);
                if (card) {
                    card.style.background = '#f0fdf4';
                    card.innerHTML = `<div style="text-align:center; padding:20px;"><h3 style="color:#15803d">üèÜ Finalizado</h3><p>Vencedor: ${dados.id_vencedor}</p><p style="font-size:1.5rem">R$ ${dados.valor.toFixed(2)}</p></div>`;
                }
            });
            eventSource.addEventListener('link_pagamento', (e) => {
                const dados = JSON.parse(e.data);
                adicionarLog('PAGAMENTO', dados);
                if(confirm(`Voc√™ venceu o Leil√£o ${dados.id_leilao}! Pagar agora?`)) console.log("Clicou pagar");
            });
            eventSource.addEventListener('status_pagamento', (e) => {
                const dados = JSON.parse(e.data);
                adicionarLog('STATUS', dados);
                alert(`Pagamento Leil√£o ${dados.id_leilao}: ${dados.status}`);
            });
            eventSource.addEventListener('lance_invalido', (e) => {
                const dados = JSON.parse(e.data);
                adicionarLog('ERRO', dados);
                alert(`Lance rejeitado no leil√£o ${dados.id_leilao}. Verifique se o leil√£o j√° come√ßou.`);
            });
        }

        // --- REST ---
        async function buscarLeiloes() {
            try {
                const res = await fetch(`${API_URL}/leiloes`);
                const leiloes = await res.json();
                const div = document.getElementById('leiloes-ativos');
                div.innerHTML = '';

                if (leiloes.length === 0) {
                    div.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#666">Nenhum leil√£o ativo. Crie um e aguarde o hor√°rio de in√≠cio.</div>';
                    return;
                }

                leiloes.forEach(l => {
                    const fim = new Date(l.fim).toLocaleTimeString();
                    div.innerHTML += `
                        <div class="leilao-card" id="card-leilao-${l.id_leilao}">
                            <div class="leilao-header">
                                <span class="leilao-title">${l.nome_produto}</span>
                                <span class="leilao-id">#${l.id_leilao}</span>
                            </div>
                            <div style="font-size:0.9rem; color:#64748b; margin-bottom:10px;">${l.descricao}</div>
                            <div class="leilao-timer">‚è≥ Encerra √†s ${fim}</div>
                            <div class="leilao-price" id="valor-leilao-${l.id_leilao}">R$ ${l.valor_atual.toFixed(2)}</div>
                            
                            <div class="lance-area">
                                <div class="lance-input-group">
                                    <input type="number" id="lance-valor-${l.id_leilao}" placeholder="Valor..." step="0.01">
                                    <button onclick="efetuarLance(${l.id_leilao})">LANCE</button>
                                </div>
                                <div class="card-actions">
                                    <button class="btn-follow" onclick="seguir(${l.id_leilao})">üîî Seguir</button>
                                    <button class="btn-unfollow" onclick="desseguir(${l.id_leilao})">üîï Desseguir</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                console.error(e);
                document.getElementById('leiloes-ativos').innerHTML = `<div style="color:red">Erro ao conectar ao Gateway (127.0.0.1:5000)</div>`;
            }
        }

        async function efetuarLance(id) {
            if (!idUsuarioGlobal) return alert('Conecte-se primeiro!');
            const valor = parseFloat(document.getElementById(`lance-valor-${id}`).value);
            if (!valor) return alert('Valor inv√°lido');

            try {
                const res = await fetch(`${API_URL}/lance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id_leilao: id, id_usuario: idUsuarioGlobal, valor: valor})
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.erro || 'Erro no lance');
                adicionarLog('ENVIADO', {leilao: id, valor: valor});
                document.getElementById(`lance-valor-${id}`).value = '';
            } catch (e) {
                alert(e.message);
                adicionarLog('FALHA_LANCE', {msg: e.message});
            }
        }

        async function seguir(id) {
            if (!idUsuarioGlobal) return alert('Conecte-se primeiro!');
            await fetch(`${API_URL}/notificacoes/registrar`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id_leilao: id, id_usuario: idUsuarioGlobal})
            });
            alert(`Seguindo leil√£o ${id}`);
        }

        async function desseguir(id) {
            if (!idUsuarioGlobal) return alert('Conecte-se primeiro!');
            await fetch(`${API_URL}/notificacoes/cancelar`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id_leilao: id, id_usuario: idUsuarioGlobal})
            });
            alert(`Deixou de seguir leil√£o ${id}`);
        }

        // Listeners
        document.getElementById('btnConectar').onclick = () => {
            const u = document.getElementById('id_usuario').value;
            if(u) conectarSSE(u); else alert('Digite ID');
        };
        document.getElementById('btnAtualizarLeiloes').onclick = buscarLeiloes;
        document.getElementById('formCriarLeilao').onsubmit = async (e) => {
            e.preventDefault();
            const now = new Date();
            const ini = new Date(document.getElementById('data_inicio').value);
            const fim = new Date(document.getElementById('data_fim').value);
            // Garante delay seguro para dar tempo do backend processar
            const safeIni = (ini < now ? now.addSeconds(5) : ini).toISOString();
            const safeFim = (fim < ini ? ini.addSeconds(60) : fim).toISOString();
            
            await fetch(`${API_URL}/leiloes`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nome_produto: document.getElementById('nome_produto').value,
                    descricao: document.getElementById('descricao').value,
                    valor_inicial: parseFloat(document.getElementById('valor_inicial').value),
                    inicio: safeIni, fim: safeFim
                })
            });
            alert('Leil√£o Agendado! Aguarde o hor√°rio de in√≠cio para dar lances.');
            e.target.reset();
            buscarLeiloes();
        };

        buscarLeiloes();
    </script>
</body>
</html>